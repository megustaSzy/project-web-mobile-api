// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // directUrl = env("DIRECT_URL")
}

model tb_user {
  id             Int     @id @default(autoincrement())
  name           String
  email          String  @unique
  password       String?
  notelp         String?
  role           Role    @default(User)
  avatar         String?
  avatarPublicId String?

  provider   String? @default("local")
  providerId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accessTokens   tb_accessToken[]
  refreshTokens  tb_refreshToken[]
  orders         tb_orders[]
  tbActivityLogs tb_activity_logs[]
}

enum Role {
  Admin
  User
}

model tb_accessToken {
  id        Int      @id @default(autoincrement())
  token     String
  tokenId   String?  @unique
  user      tb_user  @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model tb_refreshToken {
  id        Int      @id @default(autoincrement())
  token     String
  tokenId   String?  @unique
  user      tb_user  @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model tb_destinations {
  id            Int     @id @default(autoincrement())
  name          String
  imageUrl      String
  imagePublicId String?
  description   String
  price         Int

  include   String[]
  ketentuan String[]
  perhatian String[]

  categoryId Int
  category   tb_category @relation(fields: [categoryId], references: [id])

  regionId Int?
  region   tb_regions? @relation(fields: [regionId], references: [id])

  orders tb_orders[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([regionId])
}

model tb_regions {
  id            Int     @id @default(autoincrement())
  name          String
  imageUrl      String?
  imagePublicId String?

  destinations tb_destinations[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model tb_pickup_locations {
  id   Int    @id @default(autoincrement())
  name String @unique

  orders tb_orders[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PaymentStatus {
  pending
  paid
  failed
  expired
}

enum PaymentMethod {
  qris
  bank_transfer
  gopay
  credit_card
}

model tb_orders {
  id Int @id @default(autoincrement())

  userId Int
  user   tb_user @relation(fields: [userId], references: [id])

  destinationId Int
  destination   tb_destinations @relation(fields: [destinationId], references: [id])

  pickupLocationId Int?
  pickupLocation   tb_pickup_locations? @relation(fields: [pickupLocationId], references: [id])

  quantity   Int
  totalPrice Int

  // Snapshot
  userName  String
  userPhone String
  userEmail String

  destinationName    String
  destinationPrice   Int
  pickupLocationName String

  date          DateTime
  departureTime String
  returnTime    String?

  ticketCode String @unique

  paymentOrderId  String  @unique
  snapToken       String?
  snapRedirectUrl String?
  transactionId   String?

  paymentStatus PaymentStatus  @default(pending)
  paymentMethod PaymentMethod?
  isPaid        Boolean        @default(false)
  paidAt        DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([destinationId])
  @@index([paymentStatus])
}

model tb_category {
  id           Int               @id @default(autoincrement())
  name         String            @unique
  destinations tb_destinations[]
}

model tb_about {
  id        Int      @id @default(autoincrement())
  title     String?
  history   String
  vision    String
  mission   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model tb_otp {
  id        Int      @id @default(autoincrement())
  email     String
  otp       String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model tb_values {
  id            Int      @id @default(autoincrement())
  header        String?
  name          String
  imageUrl      String?
  imagePublicId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model tb_ourTeam {
  id            Int     @id @default(autoincrement())
  name          String
  job           String
  imageUrl      String?
  imagePublicId String?
}

model tb_testimoni {
  id             Int             @id @default(autoincrement())
  name           String?
  email          String?
  profession     String?
  comment        String
  rating         Float?
  approvalStatus TestimoniStatus @default(PENDING)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model tb_banner {
  id            Int      @id @default(autoincrement())
  number        String
  header        String
  name          String
  imageUrl      String?
  imagePublicId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

enum TestimoniStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ActivityAction {
  ADMIN_LOGIN
  ADMIN_LOGOUT
  USER_LOGIN
  USER_LOGOUT

  ADMIN_CREATE_DESTINATION
  ADMIN_UPDATE_DESTINATION
  ADMIN_DELETE_DESTINATION

  ADMIN_CREATE_CATEGORY
  ADMIN_UPDATE_CATEGORY
  ADMIN_DELETE_CATEGORY

  ADMIN_CREATE_REGION
  ADMIN_UPDATE_REGION
  ADMIN_DELETE_REGION

  ADMIN_CREATE_PICKUP
  ADMIN_UPDATE_PICKUP
  ADMIN_DELETE_PICKUP

  ADMIN_UPDATE_USER
  ADMIN_DELETE_USER

  ADMIN_APPROVE_TESTIMONI
  ADMIN_REJECT_TESTIMONI
  ADMIN_UPDATE_TESTIMONI
  ADMIN_DELETE_TESTIMONI

  ADMIN_CREATE_BANNER
  ADMIN_UPDATE_BANNER
  ADMIN_DELETE_BANNER

  ADMIN_CREATE_ABOUT
  ADMIN_UPDATE_ABOUT
  ADMIN_DELETE_ABOUT

  ADMIN_CREATE_VALUE
  ADMIN_UPDATE_VALUE
  ADMIN_DELETE_VALUE

  ADMIN_CREATE_TEAM
  ADMIN_UPDATE_TEAM
  ADMIN_DELETE_TEAM

  ADMIN_UPDATE_PROFILE
  USER_UPDATE_PROFILE

  USER_CREATE_ORDER
  USER_PAYMENT_SUCCESS
  USER_PAYMENT_FAILED
}

model tb_activity_logs {
  id Int @id @default(autoincrement())

  userId Int?
  user   tb_user? @relation(fields: [userId], references: [id], onDelete: SetNull)

  role        Role
  action      ActivityAction
  description String

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([role])
  @@index([action])
  @@index([createdAt])
}
